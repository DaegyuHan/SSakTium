<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<h1>장바구니</h1>
<p>안녕하세요, <span th:text="${userName}"></span>님!</p>
<div id="cart-items">
    <ul>
        <th:block th:each="cartItem : ${cartItems}">
            <li id="item-${cartItem.key}"
                data-productName="${cartItem.value.productName}"
                data-price="${cartItem.value.price}"
                data-amount="${cartItem.value.amount}">
                <span th:text="${cartItem.value.productName}">상품명</span> -
                <span th:text="${cartItem.value.amount}">수량</span> 개 -
                <span class="item-price" th:text="${cartItem.value.price}">가격</span> 원
                <button onclick="removeItem('[[${cartItem.key}]]')">삭제</button>
            </li>
        </th:block>
    </ul>
</div>

<!-- 총 결제 금액 표시 영역 -->
<p>총 결제 금액: <span class="total-price" id="total-price">0</span> 원</p>

<button id="checkout-btn" onclick="checkout()">주문하기</button>

<script>
    // 페이지 로드 시 총 결제 금액을 계산하여 표시
    $(document).ready(function() {
        calculateTotalPrice();
    });

    // 총 결제 금액 계산 함수
    function calculateTotalPrice() {
        let totalPrice = 0;

        // 각 아이템의 가격과 수량을 추출해 총 결제 금액을 계산
        $("#cart-items li").each(function() {
            const price = parseFloat($(this).find(".item-price").text()) || 0;
            totalPrice += price;
        });

        // 합산한 총 결제 금액을 화면에 표시
        $("#total-price").text(totalPrice);
    }

    // 아이템 삭제 함수
    function removeItem(productId) {
        console.log(productId)
        $.ajax({
            url: "/v2/carts?productId=" + productId,
            method: "DELETE",
            success: function () {
                $("#item-" + productId).remove(); // 화면에서 해당 아이템 삭제
                calculateTotalPrice(); // 총 결제 금액 업데이트
            },
            error: function () {
                alert("삭제에 실패했습니다.");
            }
        });
    }

    function checkout() {
        const totalPrice = parseFloat($("#total-price").text()) || 0;

        $.ajax({
            url: "/ssaktium/order-place",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({ totalPrice: totalPrice }),
            success: function(response) {
                // 서버에서 반환된 `order-place` 페이지를 현재 페이지로 로드
                $("body").html(response);
            },
            error: function() {
                alert("주문 처리에 실패했습니다. 다시 시도해주세요.");
            }
        });
    }
</script>
</body>
</html>
